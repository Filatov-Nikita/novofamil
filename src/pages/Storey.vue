<template>
  <app-page class="tw-pb-40 lg:tw-py-0">
    <div class="tw-container">
      <div
        v-if="!imageMap && $store.getters['loaders/is']('loading storeys')"
        class="tw-absolute">
        <Spinner class="tw-absolute" size="100px" />
      </div>
      <div class="content" v-else>
        <div class="first lg:tw-flex 2xl:tw-block tw-gap-[33px] lg:tw-pt-30">
          <div>
            <router-link
              class="tw-underline tw-text-white tw-block tw-mb-30 md:tw-mb-40 lg:tw-mb-20"
              :to="{ name: 'facad.house' }">
              Назад к фасаду
            </router-link>
            <div class="2xl:tw-grid 2xl:tw-place-content-center">
              <div
                class="2xl:tw-text-xl tw-text-lg tw-text-white tw-uppercase tw-font-nord tw-leading-120 tw-mb-20 md:tw-mb-40 lg:tw-hidden 2xl:tw-block">
                Секция {{ storey.entrance }},
                <br class="md:tw-hidden lg:tw-block" />
                Этаж {{ storey.number }}
              </div>
              <div>
                <div
                  class="tw-hidden lg:tw-block tw-w-[70px] tw-text-center tw-text-secondary tw-h-20 tw-mb-20">
                  Этаж
                </div>
                <div class="tw-flex tw-flex-row-reverse tw-flex-wrap tw-gap-10 lg:tw-w-[70px] tw-mb-30 lg:tw-mb-0">
                  <div v-for="storey in storeys" :key="storey.id">
                    <ButtonStorey
                      :label="storey.value"
                      :active="isActive(storey.id)"
                      @click="changeStorey(storey.id)" />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div>
            <div
              class="tw-text-[32px] tw-leading-120 tw-font-nord tw-text-white tw-mb-20 md:tw-mb-40 tw-hidden lg:tw-block 2xl:tw-hidden">
              Секция {{ storey.entrance }}, <br class="2xl:tw-hidden" />
              Этаж {{ storey.number }}
            </div>
          </div>
        </div>

        <div class="map" v-if="storey && imageMap">
          <StoreyPlan
            class=""
            :imageMap="imageMap"
            @update:showed="showedFlat = $event" />
        </div>
        <div class="last">
          <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M63.5 39C63.5 52.531 52.531 63.5 39 63.5C25.469 63.5 14.5 52.531 14.5 39C14.5 25.469 25.469 14.5 39 14.5C52.531 14.5 63.5 25.469 63.5 39Z" stroke="#D6DEDF"/>
            <path d="M51.9983 39.3963C51.9948 39.605 51.9085 39.8066 51.7584 39.9567C51.6083 40.1067 51.4068 40.193 51.1981 40.1966L39.3934 40.3955L39.1945 52.2006C39.1912 52.3796 39.1271 52.5542 39.0126 52.6956C38.8981 52.837 38.7401 52.9368 38.5647 52.9784C38.3893 53.0201 38.2069 53.0011 38.0477 52.9247C37.8885 52.8482 37.7619 52.7189 37.6889 52.558L27.069 29.1333C27.0027 28.988 26.9836 28.8242 27.0142 28.6644C27.0448 28.5045 27.1236 28.3563 27.24 28.24C27.3563 28.1237 27.5045 28.0448 27.6644 28.0142C27.8242 27.9836 27.9879 28.0027 28.1333 28.069L51.557 38.6893C51.6918 38.7502 51.8051 38.849 51.8835 38.9739C51.962 39.0989 52.0023 39.2449 51.9999 39.3947L51.9983 39.3963Z" fill="#D6DEDF"/>
            <path d="M16.7175 3.28249C20.4275 6.99247 20.4275 13.0075 16.7175 16.7175C13.0075 20.4275 6.99247 20.4275 3.28249 16.7175C-0.427495 13.0075 -0.427494 6.99246 3.28249 3.28248C6.99247 -0.427496 13.0075 -0.427495 16.7175 3.28249Z" fill="#FA864B" stroke="#FA864B"/>
            <path d="M10.4677 13.0113C9.83568 13.0113 9.27968 12.8833 8.79968 12.6273C8.31968 12.3713 7.94768 12.0113 7.68368 11.5473C7.42768 11.0753 7.29968 10.5313 7.29968 9.91534C7.29968 9.30734 7.43168 8.77134 7.69568 8.30734C7.95968 7.83534 8.32768 7.47134 8.79968 7.21534C9.27968 6.95134 9.83168 6.81934 10.4557 6.81934C11.3197 6.81934 12.0677 7.12334 12.6997 7.73134L11.8837 8.60734C11.7077 8.43134 11.4957 8.29534 11.2477 8.19934C10.9997 8.09534 10.7437 8.04334 10.4797 8.04334C9.93568 8.04334 9.49168 8.21934 9.14768 8.57134C8.81168 8.91534 8.64368 9.36334 8.64368 9.91534C8.64368 10.4753 8.81168 10.9273 9.14768 11.2713C9.49168 11.6153 9.93568 11.7873 10.4797 11.7873C10.7677 11.7873 11.0397 11.7353 11.2957 11.6313C11.5517 11.5273 11.7677 11.3753 11.9437 11.1753L12.7717 12.0753C12.4437 12.3953 12.0917 12.6313 11.7157 12.7833C11.3397 12.9353 10.9237 13.0113 10.4677 13.0113Z" fill="white"/>
          </svg>
          <svg
            v-if="storey.entrance == 1"
            width="54"
            height="98"
            viewBox="0 0 54 98"
            fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <rect
              x="47"
              y="35"
              width="6"
              height="31"
              rx="1"
              fill="#B8C6D6"
              fill-opacity="0.4"
              stroke="#2F4258"
              stroke-opacity="0.15" />
            <path
              d="M43 3.17818C44.8856 3.17818 45.8284 3.17818 46.4142 3.76397C47 4.34975 47 5.29256 47 7.17818L47 16C47 17.8856 47 18.8284 46.4142 19.4142C45.8284 20 44.8856 20 43 20L30.1007 20C29.8295 20 29.6098 19.7802 29.6098 19.5091C29.6098 19.238 29.39 19.0182 29.1188 19.0182L5 19.0182C3.11438 19.0182 2.17157 19.0182 1.58578 18.4324C0.999999 17.8466 0.999999 16.9038 0.999999 15.0182L1 6C1 4.11438 1 3.17157 1.58578 2.58578C2.17157 2 3.11438 2 5 2L17.5207 2C17.846 2 18.1098 2.26374 18.1098 2.58909C18.1098 2.91444 18.3735 3.17818 18.6988 3.17818L43 3.17818Z"
              fill="#F5F5F5"
              stroke="#9BA5B0" />
            <path
              d="M43 81.1108C44.8856 81.1108 45.8284 81.1108 46.4142 81.6966C47 82.2824 47 83.2252 47 85.1108L47 93C47 94.8856 47 95.8284 46.4142 96.4142C45.8284 97 44.8856 97 43 97L30.0726 97C29.817 97 29.6098 96.7928 29.6098 96.5372C29.6098 96.2816 29.4025 96.0743 29.1469 96.0743L5 96.0743C3.11438 96.0743 2.17157 96.0743 1.58578 95.4886C0.999999 94.9028 0.999999 93.96 0.999999 92.0743L1 84C1 82.1144 1 81.1716 1.58578 80.5858C2.17157 80 3.11438 80 5 80L17.5544 80C17.8611 80 18.1098 80.2487 18.1098 80.5554C18.1098 80.8621 18.3584 81.1108 18.6652 81.1108L43 81.1108Z"
              fill="#F5F5F5"
              stroke="#9BA5B0" />
            <path
              d="M43 43.1108C44.8856 43.1108 45.8284 43.1108 46.4142 43.6966C47 44.2824 47 45.2252 47 47.1108L47 55C47 56.8856 47 57.8284 46.4142 58.4142C45.8284 59 44.8856 59 43 59L30.0726 59C29.817 59 29.6098 58.7928 29.6098 58.5372C29.6098 58.2816 29.4025 58.0743 29.1469 58.0743L5 58.0743C3.11438 58.0743 2.17157 58.0743 1.58578 57.4886C0.999999 56.9028 0.999999 55.96 0.999999 54.0743L1 46C1 44.1144 1 43.1716 1.58578 42.5858C2.17157 42 3.11438 42 5 42L17.5544 42C17.8611 42 18.1098 42.2487 18.1098 42.5554C18.1098 42.8621 18.3584 43.1108 18.6652 43.1108L43 43.1108Z"
              fill="#F5F5F5"
              stroke="#3AB2ED" />
            <path
              d="M24 43.1108L18.6733 43.1108C18.3621 43.1108 18.1098 42.8621 18.1098 42.5554C18.1098 42.2487 17.8574 42 17.5462 42L3.875 42C2.51971 42 1.84207 42 1.42103 42.4149C1 42.8299 1 43.4977 1 44.8333L0.999999 55.241C0.999999 56.5766 0.999999 57.2445 1.42103 57.6594C1.84207 58.0743 2.51971 58.0743 3.87499 58.0743L24 58.0743L24 43.1108Z"
              fill="#3AB2ED"
              fill-opacity="0.48" />
            <path
              d="M11.8066 50.9502L12.5644 51.1416C12.4055 51.764 12.1191 52.2393 11.705 52.5674C11.2935 52.8929 10.7896 53.0557 10.1933 53.0557C9.57609 53.0557 9.07349 52.9307 8.68547 52.6807C8.30005 52.4281 8.00578 52.0635 7.80266 51.5869C7.60214 51.1104 7.50187 50.5986 7.50187 50.0518C7.50187 49.4554 7.61516 48.9359 7.84172 48.4932C8.07089 48.0479 8.3951 47.7106 8.81437 47.4814C9.23625 47.2497 9.69979 47.1338 10.205 47.1338C10.7779 47.1338 11.2597 47.2796 11.6503 47.5713C12.0409 47.863 12.3131 48.2731 12.4667 48.8018L11.7206 48.9775C11.5878 48.5609 11.3951 48.2575 11.1425 48.0674C10.8899 47.8773 10.5722 47.7822 10.1894 47.7822C9.74927 47.7822 9.38078 47.8877 9.08391 48.0986C8.78964 48.3096 8.5826 48.5934 8.46281 48.9502C8.34302 49.3044 8.28312 49.6702 8.28312 50.0479C8.28312 50.5348 8.35344 50.9606 8.49406 51.3252C8.63729 51.6872 8.85865 51.958 9.15812 52.1377C9.4576 52.3174 9.78182 52.4072 10.1308 52.4072C10.5553 52.4072 10.9146 52.2848 11.2089 52.04C11.5032 51.7952 11.7024 51.432 11.8066 50.9502ZM15.7052 52.958L15.002 52.958L15.002 48.4775C14.8328 48.639 14.6101 48.8005 14.3341 48.9619C14.0606 49.1234 13.8145 49.2445 13.5958 49.3252L13.5958 48.6455C13.989 48.4606 14.3328 48.2367 14.627 47.9736C14.9213 47.7106 15.1296 47.4554 15.252 47.208L15.7052 47.208L15.7052 52.958Z"
              fill="#F5F5F5" />
            <rect
              x="47"
              y="1"
              width="6"
              height="31"
              rx="1"
              fill="#B8C6D6"
              fill-opacity="0.4"
              stroke="#2F4258"
              stroke-opacity="0.15" />
            <rect
              x="47"
              y="69"
              width="6"
              height="26"
              rx="1"
              fill="#B8C6D6"
              fill-opacity="0.4"
              stroke="#2F4258"
              stroke-opacity="0.15" />
          </svg>

          <svg
            v-else
            xmlns="http://www.w3.org/2000/svg"
            width="54"
            height="98"
            viewBox="0 0 54 98"
            fill="none">
            <rect
              x="47"
              y="35"
              width="6"
              height="31"
              rx="1"
              fill="#B8C6D6"
              fill-opacity="0.4"
              stroke="#2F4258"
              stroke-opacity="0.15" />
            <path
              d="M43 3.17818C44.8856 3.17818 45.8284 3.17818 46.4142 3.76397C47 4.34975 47 5.29256 47 7.17818L47 16C47 17.8856 47 18.8284 46.4142 19.4142C45.8284 20 44.8856 20 43 20L30.1007 20C29.8295 20 29.6098 19.7802 29.6098 19.5091C29.6098 19.238 29.39 19.0182 29.1188 19.0182L5 19.0182C3.11438 19.0182 2.17157 19.0182 1.58578 18.4324C0.999999 17.8466 0.999999 16.9038 0.999999 15.0182L1 6C1 4.11438 1 3.17157 1.58578 2.58578C2.17157 2 3.11438 2 5 2L17.5207 2C17.846 2 18.1098 2.26374 18.1098 2.58909C18.1098 2.91444 18.3735 3.17818 18.6988 3.17818L43 3.17818Z"
              fill="#F5F5F5"
              stroke="#9BA5B0" />
            <path
              d="M43 81.1108C44.8856 81.1108 45.8284 81.1108 46.4142 81.6966C47 82.2824 47 83.2252 47 85.1108L47 93C47 94.8856 47 95.8284 46.4142 96.4142C45.8284 97 44.8856 97 43 97L30.0726 97C29.817 97 29.6098 96.7928 29.6098 96.5372C29.6098 96.2816 29.4025 96.0743 29.1469 96.0743L5 96.0743C3.11438 96.0743 2.17157 96.0743 1.58578 95.4886C0.999999 94.9028 0.999999 93.96 0.999999 92.0743L1 84C1 82.1144 1 81.1716 1.58578 80.5858C2.17157 80 3.11438 80 5 80L17.5544 80C17.8611 80 18.1098 80.2487 18.1098 80.5554C18.1098 80.8621 18.3584 81.1108 18.6652 81.1108L43 81.1108Z"
              fill="#F5F5F5"
              stroke="#9BA5B0" />
            <path
              d="M43 43.1108C44.8856 43.1108 45.8284 43.1108 46.4142 43.6966C47 44.2824 47 45.2252 47 47.1108L47 55C47 56.8856 47 57.8284 46.4142 58.4142C45.8284 59 44.8856 59 43 59L30.0726 59C29.817 59 29.6098 58.7928 29.6098 58.5372C29.6098 58.2816 29.4025 58.0743 29.1469 58.0743L5 58.0743C3.11438 58.0743 2.17157 58.0743 1.58578 57.4886C0.999999 56.9028 0.999999 55.96 0.999999 54.0743L1 46C1 44.1144 1 43.1716 1.58578 42.5858C2.17157 42 3.11438 42 5 42L17.5544 42C17.8611 42 18.1098 42.2487 18.1098 42.5554C18.1098 42.8621 18.3584 43.1108 18.6652 43.1108L43 43.1108Z"
              fill="#F5F5F5"
              stroke="#3AB2ED" />
            <path
              d="M46.579 43.1229C46.1579 42.708 45.4803 42.708 44.125 42.708L24 42.708L24 57.6715L29.1401 57.6715C29.3995 57.6715 29.6098 57.8788 29.6098 58.1344C29.6098 58.39 29.82 58.5972 30.0794 58.5972L44.125 58.5972C45.4803 58.5972 46.1579 58.5972 46.579 58.1823C47 57.7673 47 57.0995 47 55.7639L47 45.5413C47 44.2057 47 43.5379 46.579 43.1229Z"
              fill="#3AB2ED"
              fill-opacity="0.48" />
            <path
              d="M34.8066 50.9502L35.5644 51.1416C35.4055 51.764 35.1191 52.2393 34.705 52.5674C34.2935 52.8929 33.7896 53.0557 33.1933 53.0557C32.5761 53.0557 32.0735 52.9307 31.6855 52.6807C31.3001 52.4281 31.0058 52.0635 30.8027 51.5869C30.6021 51.1104 30.5019 50.5986 30.5019 50.0518C30.5019 49.4554 30.6152 48.9359 30.8417 48.4932C31.0709 48.0479 31.3951 47.7106 31.8144 47.4814C32.2362 47.2497 32.6998 47.1338 33.205 47.1338C33.7779 47.1338 34.2597 47.2796 34.6503 47.5713C35.0409 47.863 35.3131 48.2731 35.4667 48.8018L34.7206 48.9775C34.5878 48.5609 34.3951 48.2575 34.1425 48.0674C33.8899 47.8773 33.5722 47.7822 33.1894 47.7822C32.7493 47.7822 32.3808 47.8877 32.0839 48.0986C31.7896 48.3096 31.5826 48.5934 31.4628 48.9502C31.343 49.3044 31.2831 49.6702 31.2831 50.0479C31.2831 50.5348 31.3534 50.9606 31.4941 51.3252C31.6373 51.6872 31.8586 51.958 32.1581 52.1377C32.4576 52.3174 32.7818 52.4072 33.1308 52.4072C33.5553 52.4072 33.9146 52.2848 34.2089 52.04C34.5032 51.7952 34.7024 51.432 34.8066 50.9502ZM39.752 52.2822L39.752 52.958L35.9669 52.958C35.9617 52.7887 35.989 52.626 36.0489 52.4697C36.1453 52.2119 36.2989 51.958 36.5098 51.708C36.7234 51.458 37.0307 51.1689 37.4317 50.8408C38.0541 50.3304 38.4747 49.9268 38.6934 49.6299C38.9122 49.3304 39.0216 49.0479 39.0216 48.7822C39.0216 48.5036 38.9213 48.2692 38.7208 48.0791C38.5229 47.8864 38.2638 47.79 37.9434 47.79C37.6049 47.79 37.3341 47.8916 37.1309 48.0947C36.9278 48.2979 36.8249 48.5791 36.8223 48.9385L36.0997 48.8643C36.1492 48.3252 36.3354 47.915 36.6583 47.6338C36.9812 47.3499 37.4148 47.208 37.9591 47.208C38.5085 47.208 38.9434 47.3604 39.2638 47.665C39.5841 47.9697 39.7442 48.3473 39.7442 48.7979C39.7442 49.027 39.6973 49.2523 39.6036 49.4736C39.5098 49.695 39.3536 49.9281 39.1348 50.1729C38.9187 50.4176 38.558 50.7536 38.0528 51.1807C37.6309 51.5348 37.3601 51.7757 37.2403 51.9033C37.1205 52.0283 37.0216 52.1546 36.9434 52.2822L39.752 52.2822Z"
              fill="#F5F5F5" />
            <rect
              x="47"
              y="1"
              width="6"
              height="31"
              rx="1"
              fill="#B8C6D6"
              fill-opacity="0.4"
              stroke="#2F4258"
              stroke-opacity="0.15" />
            <rect
              x="47"
              y="69"
              width="6"
              height="26"
              rx="1"
              fill="#B8C6D6"
              fill-opacity="0.4"
              stroke="#2F4258"
              stroke-opacity="0.15" />
          </svg>
        </div>
      </div>
    </div>
  </app-page>
</template>

<script>
import ButtonStorey from "@/components/ButtonStorey.vue";
import StoreyPlan from "@/components/StoreyPlan.vue";
import { ref, toRef, watch, computed } from "vue";
import { useStore } from "vuex";
import { useRouter } from "vue-router";

export default {
  props: {
    id: {
      required: true,
      type: [String, Number],
    },
  },
  setup(props) {
    const store = useStore();
    const router = useRouter();
    const storey = ref(null);
    const entrance = ref(null);
    const showedFlat = ref(null);
    const id = toRef(props, "id");

    const getEntrance = async (id) => {
      store.dispatch("loaders/start", "loading entrance");
      entrance.value = await store.dispatch("entrances/entrancesOne", { id });
      store.dispatch("loaders/end", "loading entrance");
    };

    const getStorey = async () => {
      store.dispatch("loaders/start", "loading storeys");
      storey.value = await store.dispatch("storeys/storeysOne", {
        id: id.value,
      });
      store.dispatch("loaders/end", "loading storeys");
    };

    const load = async () => {
      await getStorey();
      await getEntrance(storey.value.entrance);
    };

    watch(id, load, { immediate: true });

    const storeys = computed(() => {
      if (!entrance.value?.storeys) return null;
      const entries = Object.entries(entrance.value?.storeys).reverse();
      return entries.map(([value, key]) => ({ id: key, value }));
    });

    const imageMap = computed(() => storey.value?.image_maps?.[0]);

    const changeStorey = (storeyId) => {
      router.push({ name: "storey", params: { id: storeyId } });
    };

    const isActive = (storeyId) => +storeyId === +id.value;

    return {
      storey,
      entrance,
      storeys,
      changeStorey,
      isActive,
      imageMap,
      showedFlat,
    };
  },
  components: {
    ButtonStorey,
    StoreyPlan,
  },
};
</script>

<style scoped>
.content {
  @apply tw-h-full;
}

.first {
}
.map {
  @apply tw-mb-40 lg:tw-mb-0;
}
.last {
  @apply tw-flex tw-justify-between tw-items-center lg:tw-justify-start 2xl:tw-justify-center lg:tw-gap-60;
}

@screen lg {
  .content {
    display: grid;
    grid-template-areas:
      "A A A  B B B B B B"
      "C C C  B B B B B B";
  }
  .first {
    grid-area: A;
    @apply lg:tw-w-[420px] 2xl:tw-w-[640px];
  }
  .map {
    min-height: calc(100vh - 63px - 87px);
    @apply lg:tw-border-l lg:tw-border-secondary/15;

    grid-area: B;
  }
  .last {
    grid-area: C;
  }
}
</style>
